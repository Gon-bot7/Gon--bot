/*
NNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNN
MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
mMMMMMMMMMNNNmmNNNMMNMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
mmNMMNMMMMNNNNNmmmddhdddNMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
mddNMMNy:/odNmmddmmNNmdhhddmNMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
NmmdNMNd:--+dNmmddhhddmmhsyhhmdmmNMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
NmNmdNmy:.-oyNmmmhmdhho+sososyhhhddNMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
NmmNdh+-`.:oyNNdmmdmmdo-://oysssyhhhdmNMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
Nmmmoyyyo+osdNmdmmddNNhs+/::/+osyssydyhdNMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
NNmhsymMMNmmmmdmdNNddNmsso+++////ossssyyhdmNMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
mhhhmNNMNNNhssshhmmddmmssyooooso/::+oysshhhhmMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
mmdhdddNNdyoosyhdmddmmmsoooooyysyys/::/oyyhhhyMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
mdddhddmhsooshdmdmdhhyyyysso/ooo+syhhs/-/+shyhMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
dyyhdmd+ososhdmdmyyhhhhhhhyo++o/+///+ohhso++sdMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
dhdmNNdsossyhmdmsydhssssyhhs/++o/o+//:++yhhy+/hNMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
mdmNNNNmhysshddyshdyyy/oss+s::/:://++///++++/::hmNNNNNNNMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
NNMNNNmmNNdymNNhshdshdyhdysh+sy+-:++osssosss++yNNMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
NmNNNmdNNmNmmmNmyyddyyhdhydyohys/-oo+osssysyyohNMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
mmNNNhdNmmNNmNMMNhyyhhhdhyyhmmyh+-/s+sysssyyhyydNMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
mNMMMhdNdmMNMMMMMNNmdhdddmhdmmNho/-osoyyo++oyddhhNMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
NMMMNmhNdNMNMNMMNmNNNmmmdyoohmhoyo::hsooo++oooydhymMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMNNNhmNNMmmNMNNmmmmdmmdyhhoyddddoo++yoyysooossyhsmMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMNNNmmNNNmdNdNmmddhhhdNNhsmNssdooo/dso++osyyysoymMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMNNNNmNNNNNmddmmNhshNmmmNmNMdhNsh/ohho++/:++MMNNMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MNNNMMNNNNmmmhhhhdyosdNmdmMMhoNmhdmys+ooo++/+MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
mmNNNMMNNNNmddmdoodmMMNmmNNhssdmNMMMNdNd/osomMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
NmNdhMNmNNMNmdNddohmMMNNNmdmdddNMMMMMMMMmMNNMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
NmNhmMmmmmNNmdNyoNMNmNmdhyyyhdhoyNMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
NmdmMmmddddNmmdys+hmMMMmmhysssyy++dMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
NmdNMMdmdddmmNNyshmNNNNNNNdhhs+yy//dMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
NmNMMMdmdddmmMNysdmNNMMMNhhNdhs+y+/:mMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
mmNMMNhmmddNNNMdyydmMMMNdyshNhyoss+:/MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
NmNMMddmmmmNMNMNdsymNNmdhhdNMNdhsss+:yMMMMMMMMMMMMMMMMNNMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMMdhmmmmmNMNNMmshNMMMmmMMMMMmNdyo+//NMMMMMMMMMMMMMMMhNMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMmhmmmmmmNMMNNMyshdhhhyhNMMMMMMdhso+sMMMMMMMMMMMMMMMhmMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMmdmmmmmmmNMMMmNm+ys++oyyNMMMMMMNmmyyoyNMMMMMMMMMMMMMddMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
NmmmmmmmmmmmNMNNmNNyyo+/oohNMMMMMMMMdhhsshmMMMMMMMMMMMyNMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
mmNNNNNNmmmmNMMNmmddNmmdhhdmMMMMMMMMMNddhssshmmNNNmmdhdMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
NNNNNNNNNNNNNNNNmNNNNMMMMMNomMMMMMMMMMNNmdhhyyyyyyyhdmMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
Nd+oNMMMMMMMmodo++++++++++m..yNMMMMMNo+mNMMmhssshdNMMNhNMMMMMMMMMMMddMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MN+ /NMMMMMm: d` -ssssss+`d. `+mMMMMN. dNm+:+syso//hNN--yNMMMMMMMd+`yMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMN+ /NMMMm: oM` +NMMMMMNdN. /`.yNMMN. dh.omMMMMMNy.oM- `:hNMMMm+.  yMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMN/ /NMm: oNy` :sssmMMMMN. dh-`/mMN. d-/NMMMMMMMMy`m- y/`/dmo..o: yMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMMN/ /m: +NNy. /yyyNMMMMN. dNNo`.yN- d.oNMMMMMMMMd d- mNh-`.`+mN/ yMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMMMN/ . +NMMN- oNMMMMMNdN. dMMMd:`/. ds.dNMMMMMMm::M- dMMNy/dMMN/ yMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMMMMN/ +NMMMN- /yyyyyys d. dMMMMNo`  dNy-+ymmmho-+NN- dMMMMMMMMN/ yMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMNyNMMMMN+::::::::::m+/mMMMMMMd: dMMNho///+ymMMN+/mMMMMMMMMNs/hMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMNMMMMMMMMMMMMMMMMMMMMMMMMMMMMNsmMMMMMMMMMMMMMMNNNNMMNNNMMNNNNMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMNMMMMMMMMMMMMMMNMMNMNMMMNMMNNMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMNMMNMNMMMNMMNNMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMNNNNMMNNNMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
*/
import latestVersion from 'latest-version';
import { Whatsapp } from '../api/whatsapp';
import { CreateConfig, defaultOptions } from '../config/create-config';
import { upToDate } from '../utils/semver';
import { asciiQr, SessionTokenCkeck} from './auth';
import { initWhatsapp, injectApi, initBrowser } from './browser';
import chalk = require('chalk');
import boxen = require('boxen');
import Spinnies = require('spinnies');
import path = require('path');
const  { version } = require('../../package.json');
import { Browser, Page } from 'puppeteer';
import { clearInterval, clearTimeout, setInterval } from 'timers';
import { constructConn, deleteToken, scrapeWebpackJsonp} from './functions'

// Global
let updatesChecked = false;

/**
 * Start the bot
 * @param session, You must pass a string type parameter, this parameter will be the name of the client's session. If the parameter is not passed, the section name will be "session".
 * @param catchQR, A callback will be received, informing the status of the qrcode
 * @param statusFind, A callback will be received, informing the customer's status
 * @param options, Pass an object with the bot settings
 * @param browserSessionToken, Pass the session token information you can receive this token with the await client.getSessionTokenBrowser () function
 * @param onState, returns the connection status!
 * @param retunToken, returns the user's token!
 * @returns Whatsapp page, with this parameter you will be able to access the bot functions
 */

export async function create(
  Session = 'session',
  catchQR?: (qrCode: string, asciiQR: string, attempt: number) => void,
  statusFind?: (statusGet: string, session: string) => void,
  options?: CreateConfig,
  browserSessionToken?: object,
  retunToken?: (token: object, session: string) => void,
  onState?: (state: string, session: string) => void
): Promise<Whatsapp | Page> {

  var disconnectOrClose: NodeJS.Timeout,
    AutoCloseBrowser: NodeJS.Timeout, //setTimeout autoClose
    intervalScrapeQrcode: NodeJS.Timeout, //setInterval qrcode
    browserToken: object, //inject browser
    waPage: Page; // puppeteer function

  interface waPage {
    isClosed: any;
  }

  const spinnies: Spinnies = new Spinnies({
    disableSpins: options ? options.disableSpins : '',
  });

  const mergedOptions = { ...defaultOptions, ...options };

  if (!mergedOptions.disableWelcome) {
    console.log(`
     
    ▐█  ██  █░▐█▀▀▀░▐█     ▄█▀▀█▄ ▄█▀▀█▄ ▐██   ██▌ ▓█▀▀▀░
     █▌▐██▄▓█ ▐█▄▄▄ ▐█    ▐█      █▒  ▐█▄▐█▀▌ ▐▌█▌ ▓█▄▄▄
     ▐██ ▐██░ ▐█    ▐█    ▐█▄  ▄▀ █▌  ▐█ ▐█ █▓█ █▌ ██
      ▀▀  ▀▀  ▀▀▀▀▀░▐▀▀▀▀▀  ▀▀▀▀   ▀▀▀▀  ▐▀  ▀  ▀▀ ▀▀▀▀▀
                                   ▄
      ▄▄░          ▄ ▄▄▄▄▄▄▄▄▄▄▄▄▄ ██         ▄▄       ▄▄▄▄      ░
      ░██▄        ██ ███▀▀▀▀▀▀▀▀█▌ ███▌       ██▄  ▄▄█▀▀▀▀▀▀█▄   ▓█▄           ▄█░
       ░██▄     ░██▀ ███           ██▀██▄     ██▄ ▄█░        ▀█▄ ▓███▄      ░████░
         ██▌   ▄██░ ▄███▄▄▄▄       ██  ▓██▄   ██▄▐█           ▐█ ▓█▌▀██▄  ▄███░██░
          ██▌ ▄██░  ▀███▀▀▀▀       ██   ▐██▌  ██▄▐█           ▐█░▓█▌  ▀█████░  ██░
           ▓████     ███           ██     ▀██▄██▄ █▌          ██ ▓█▌    ▀█░    ██░
            ▀██      ███        █▌ ██       ▀███▄  ▀█▄     ▄▄█▀  ▓█▌           ██░
             ▀       ▀███████████▌ ██        ░██▄    ▀▀███▀▀░    ▀█▌           ▓█░
                                              ▀░                                   \n`);
  }

  // Check for updates if needed
  if (!updatesChecked && mergedOptions.updatesLog) {
    spinnies.add(`${Session}-venom-version-spinner`, {
      text: 'Checking for updates',
    });
    checkVenomVersion(spinnies, Session);
    updatesChecked = true;
  }

  // Initialize whatsapp
  spinnies.add(`${Session}-browser`, {
    text: 'Waiting... checking the browser...',
  });

  // Opening a connection through the browser or wss
  var browser = await initBrowser(Session, mergedOptions);

  // Erro of connect wss
  if (browser === 'connect') {
    spinnies.fail(`${Session}-browser`, {
      text: `Error when try to connect ${mergedOptions.browserWS}`,
    });
    throw `Error when try to connect ${mergedOptions.browserWS}`;
  }

  // Erro open browser
  if (browser === 'launch') {
    spinnies.fail(`${Session}-browser`, {
      text: `Error no open browser`,
    });
    throw `Error no open browser`;
  }

  spinnies.succeed(`${Session}-browser`, {
    text: `Browser successfully opened`,
  });

  // check if the wss function is on
  if (!mergedOptions.browserWS) {

    spinnies.add(`${Session}-browserActive`, {
      text: 'check headless...',
    });

    //check if the browser is visible or not
    if (mergedOptions.headless) {
      spinnies.succeed(`${Session}-browserActive`, {
        text: 'headless option is active, browser hidden',
      });
    } else {
      spinnies.succeed(`${Session}-browserActive`, {
        text: 'headless option is disabled, browser visible',
      });
    }

    // checking that the browser has been closed
    browser['_process'].once('close', () => {
      browser['isClose'] = true;
    });

  }

  // disconnect (wss) or close (browser) 
  disconnectOrClose = setInterval(() => {
    // disconnect (wss)
    if (mergedOptions.browserWS) {
      if (browser.isConnected() === false) {
        
        try {
          spinnies.fail(`${Session}-auth`, {
            text: 'Authentication failure'
          });
          spinnies.fail(`${Session}-jsonp`, {
            text: 'Fail injected state'
          });
          spinnies.fail(`${Session}-inject`, {
            text: 'Error Sibionte'
          });
        } catch { }

        if (browser.isConnected() === false) {
          spinnies.add(`${Session}-wss`, {
            text: '....',
          });

          spinnies.fail(`${Session}-wss`, {
            text: `The server is closed ${Session}`,
          });

          if (statusFind) {
            statusFind('serverClose', Session);
          }

          browser.close();
          clearTimeout(AutoCloseBrowser);// clear autoClose
          clearInterval(intervalScrapeQrcode);
          clearInterval(disconnectOrClose);

        }
      }
    }

    if (browser['isClose'] != undefined && !mergedOptions.browserWS) {

      try {
        spinnies.fail(`${Session}-auth`, {
          text: 'Authentication failure'
        });
        spinnies.fail(`${Session}-jsonp`, {
          text: 'Fail injected state'
        });
        spinnies.fail(`${Session}-inject`, {
          text: 'Error Sibionte'
        });
      } catch { }

      spinnies.add(`${Session}-browserClose`, {
        text: '....',
      });

      spinnies.fail(`${Session}-browserClose`, {
        text: 'The browser is closed',
      });

      if (statusFind) {
        statusFind('browserClose', Session);
      }

      clearTimeout(AutoCloseBrowser);// clear autoClose
      clearInterval(disconnectOrClose);
    }

  }, 1000);

  if (SessionTokenCkeck(browserSessionToken)) {
    browserToken = browserSessionToken;
  }

  spinnies.add(`${Session}-whatzapp`, {
    text: 'Starting whatzapp...',
  });

  waPage = await initWhatsapp(
    Session,
    mergedOptions,
    browser,
    browserToken
  );

  spinnies.succeed(`${Session}-whatzapp`, {
    text: 'Whatzapp started successfully...',
  });

  if (typeof waPage.isClosed === 'function' && waPage.isClosed() === false) {

    spinnies.add(`${Session}-auth`, {
      text: 'Authenticating...'
    });

    //Promise del token
    deleteToken(waPage, Session, mergedOptions, spinnies, async () => {
      if (statusFind) {
        statusFind('deleteToken', Session);
      }
    });

    // inject state browser
    try {
      const conn = new constructConn(true);
      let result = new Promise<Whatsapp | Page>(async (resolve) => {
        waPage.on('load', async () => {
          var result = await scrapeWebpackJsonp(
            waPage,
            AutoCloseBrowser,
            spinnies,
            disconnectOrClose,
            intervalScrapeQrcode,
            Session,
            browser,
            mergedOptions,
            browserToken,
            conn,
            (statusGet, session) => {
              if (statusFind) {
                statusFind(statusGet, Session);
              }
            },
            (qrCode, asciiQR, attempt) => {
              if (catchQR) {
                catchQR(qrCode, asciiQR, attempt);
              }
            },
            (state, session) => {
              if (onState) {
                onState(state, session);
              }
            },
            (token, session) => {
              retunToken(token, session);
            });
          if (result) {
            spinnies.succeed(`${Session}-auth`, {
              text: 'Successfully authenticated'
            });
            let wapp: Whatsapp | Page;
            if (!mergedOptions.wapage) {
              wapp = new Whatsapp(waPage);
            } else {
              wapp = waPage;
            }
            return resolve(wapp);
          }
        });
      });
      return result;
    } catch (e) {
      spinnies.fail(`${Session}-auth`, {
        text: 'Authentication failure'
      });
      throw e;
    }
  }

}

/**
 * Checs for a new versoin of venom and logs
 */
function checkVenomVersion(
  spinnies: Spinnies, 
  session: string
  ) {
  latestVersion('venom-bot').then((latest) => {
    if (!upToDate(version, latest)) {
      logUpdateAvailable(version, latest);
    }
    spinnies.succeed(`${session}-venom-version-spinner`, { text: 'Checking for updates' });
  });
}

/**
 * Logs a boxen of instructions to update
 * @param current
 * @param latest
 */
function logUpdateAvailable(
  current: string, 
  latest: string
  ){
  // prettier-ignore
  const newVersionLog =
    `There is a new version of ${chalk.bold(`Venom`)} ${chalk.gray(current)} ➜  ${chalk.bold.green(latest)}\n` +
    `Update your package by running:\n\n` +
    `${chalk.bold('\>')} ${chalk.blueBright('npm update venom-bot')}`;

  console.log(boxen(newVersionLog, { padding: 1 }));
  console.log(
    `For more info visit: ${chalk.underline(
      'https://github.com/orkestral/venom/blob/master/Update.md'
    )}\n`
  );
}

